---
title: 'Numerical trajectory patterns of floating macroalgae'
author: "Ross Coppin"
output:
  html_document:
  word_document:
  pdf_document:
    fig_caption: yes
bibliography: references.bib
csl: markdown/frontiers.csl.txt
---

```{r software, message=FALSE, warning=FALSE, include=FALSE}
## Load software need for entire script

#library(computeMSD)
library(ggplot2)
library(rgdal)
library(tidyverse)
library(viridis)
library(gridExtra)
library(ggpubr)
#library(ggord)
library(vegan)
library(dplyr)
library(ggpubr)
library(maps)
library(flextable)
library(officer)
library(tidync)
library(tidyverse)
library(hexbin)

```


# Introduction

There is a range of objects, both natural and anthropogenic, floating in the ocean of which macroalgae are regarded as one of the most important passive dispersal mechanisms of marine taxa. Floating kelp acts as a passive dispersal mechanism for a range of marine taxa and is sometimes referred to as the 'tumble-weed' of the ocean [@edgar1987; @bushing1994; @norton1992; @helmuth1994; @holmquist1994; @smith2002; @McCormick2008]. Considerable research has been performed investigating macroalgae as a passive dispersal mechanism in the ocean, however, in recent years much of the focus has shifted towards microplastics. 

Some macroalgae species are negatively buoyant and sink to the seafloor when detached from the substrate, while other species of macroalgae have air-filled pneumatocysts or stipes which allow the plants to reach the surface where light is more abundant. In turn, the positively buoyant pneumatocysts cause plants to float to the surface when dislodged from the substratum. The structure and number of pneumatocysts varies between species. For example species from the genera *Macrocystis*, *Sargassum*, *Ascophyllum*, and *Fucus* have thalli with many small pneumatocysts, while other kelp species such as *Nereocystis luetkeana*, *Pelagophycus porra*, *Ecklonia radiata*, *Ecklonia maxima* have a single, large pneumatocysts [@dayton1985; @smith2002; @thiel2005; @graiff2016; @batista2018]. In some cases the stipe itself is air-filled, such as with *E. maxima* and *E. radiata*. Although there have been reports of floating Chlorophyta species and some Rhodophyta species, Phaeophyceae species are the most commonly reported forms of floating algae. This is most likely because the green and red species reported floating are not actually positively buoyant, but instead are kept at the surface by gas trapped inbetween or in the thalli [@dromgoole1982; @back2000]. The giant kelp *Macrocystis pyrifera* [@helmuth1994; @kingsford1995; @hobday2000; @macaya2005; @graiff2016; @batista2018] and the bull kelp *Durvillaea antarctica* [@collins2010; @tala2013 ; @tala2017; @saunders2014; @smith2002; @wichmann2012; @batista2018] have been the focus of much of the research regarding spatial and temporal dispersal patterns, the ecological role of rafting, marine connectivity and raft-time.

Past research points to macroalgae trajectory being largely determined by prevailing wind conditions and surface currents [@thiel2005, @thiel2005; @hobday2000; @fraser2011; @rothausler2011; @rothausler2011]. Although ocean currents are regarded as the primary influence, the relative importance of wind versus surface current is still not known; although the role of wind has been recognised as important in several studies. For example, a study by @harrold1989 investigated the seasonal trajectories of radio-transmitter tagged *M. pyrifera* in nearshore Monterrey Bay. The results showed that kelp rafts with little surface area exposed to the wind were largely driven by a combination of wind and wind waves, however the relative importance of wind and wind waves was not clear. In addition, the tagged kelp trajectories were more consistent with the formation of eddies during winter. Previous studies have identified wind as an important mechanism of dispersal in wind dominated ocean systems. For example the subAntartic latitudes the West Wind Drift causes continuous unidirectional surface flow and is regarded as an important potential mechanism for dispersal of floating kelp. Other studies have used genetic approaches to determine macroalgae raft trajectory characteristics by inferring source location from genetically similar populations [@nikula2013]. For example, a study by @fraser2011 on the rafting capabilities of *Durvillaea antarctica* used a combination of population genetics and relative age estimate of ‘goosebarnacles’ attached to the raft. The presence of goosebarnacles suggests a long raft time as these species have a slow growth rate; while the genetic analyses showed these species are able to raft up to $\sim$ 390km from their local origin. The authors suggested that wind and water-movement were the primary influences of trajectory, however, this was only inferred from the genetic results and local climatology data [@fraser2011]. 

Other aspects such as buoyancy and drag also play a role in determining the trajectory and rate of transport for surface floating material. However, the past research on macroalgal trajectory has not investigated these factors which have been shown to be important aspects of trajectory for other materials such as icebergs, marine craft and microplastics. The "sail" area of an object floating at sea is the surface area exposed to the wind which results in air form drag, while the area of the object below the surface of the water is exposed to surface currents which result in water form drag. Drag coefficients related to wind and surface current have been shown to be important properties to consider when estimating trajectory and forecasting drift for search and sea rescue operations. Drag is ultimately determined by the size and shape of the object which are properties that vary considerably with macroalgae species. In addition, past research conducted within the maritime industry has shown that the size and shape of a vessel determine the relative importance of waves or wind as drivers of trajectory, as well as orientation of the object. If the length of the object is longer than the significant wave height then waves will be the primary driver of trajectory while the opposite is true for smaller objects where the effect of waves is regarded as negligible [@breivik2011; @griffin2017]. 

To accurately determine the trajectory of marine macroalgae these aspects need to be taken into account. Past research by @allen1999 and @breivik2011 have provided estimates of drag for various objects based on experimental work, which consisted of both direct and indirect methods of the Leeway model. However, this work does not consider biological material such as macroalgae. Although drag estimates do exist, these have been calculated for macroalgae not detached from the substratum and are regarded as fixed-point estimates. Methods used in the field of chemical engineering provide an alternative approach to estimating drag of macroalgae by means of formulas to calculate drag based on shape. Chemical engineers in the field of fluid dynamics which come across similar problems when including drag use an approach known as a 'spherecity factor'. A spherecity factor is expressed mathematically by $\psi=s/s_d$, and the ratio of the surface area of a sphere having the volume as the irregular shaped particle ($s$) to the actual surface area of the particle ($s_d$). The values are dependent on the shape of the object and a range of values have been determined based on numerous experimental work. 

Although various approaches have been used in the past to investigate floating macroalagae trajectory, very few studies have employed the use of Langrangian trajectory modelling. Furthermore, non of the existing studies using this modeling approach have considered macroalgal morphology (i.e. shape) as an aspect of drag and ultimately trajectory. Currently, work by @brooks2019 which investigated the effect of inertia and radial size on the trajectory of pelagic *Sargussum* rafts. The study used a custom growth model to estimate changes in biomass and ultimately radial size, while a customised Hybrid Coordinate Ocean Model (HYCOM) for the trajectory simulations was used. The results showed that trajectory of pelagic *Sargussum* was significantly influenced by inertia and the radial size of the rafts. Langrangian trajectory modeling is a useful tool, however, the various models available often assume the object to be a spherical particle, which is obviously not the case for both biological and anthropogenic forms of marine debris in nature. The radial size included by @brooks2019 is an improvement, however this approach does not take into account the complex morphology on an individual level into account.

In this study, a numerical approach is used to shed light on the role of water and direct wind drag on macroalgal drift trajectory using lagrangian based trajectory simulations. This will be achieved by comparing the trajectory outputs of virtual 'passive' particles (no drag characteristics added) with kelp particles (drag characteristics added) of varying degrees of water and wind drag exposure. The different degrees of wave and wind exposure are meant to reflect the different buoyancy characteristics, as well as identify the role of magnitude of the drag components on overall trajectory. 

# Methods

## Study site

The region of interest for this study was the Cape Peninsula in the Western Cape, South Africa. This was further sub-divided into two domains, the Atlantic domain and False Bay domain (see figure \ref{fig:map}A). One release site is located in each of the domains, namely Kommetjie in the Atlantic and Buffelsbaai in False Bay (see figure \ref{fig:map}B). The hydrodynamics between the two domains are driven by a complex interaction of wind and wave vectors, with wind driven processes primarily occurring in False Bay. For a more detailed explanation of the hydrodynamics of these two domains the reader is referred to @coppin2020. The hydrodynamic characteristics of these regions are also influenced by larger oceanic processes, which in South Africa can largely be attributed to the Agulhas Current (AC) and the Benguela Current (BC). The AC is a component of the South-west Indian Ocean sub-gyre, flowing predominantly southwestward following the continental shelf edge and eventually retroflecting eastward back into the South Indian Ocean. 

```{r map data, message=FALSE, warning=FALSE, include=FALSE}

source("map/scaleBarFunc.R")

load("map/south_africa_coast_hi_res.Rdata")

map_pen <- ggplot(data = south_africa_coast_hi_res) +
geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
            size = 1.0, colour = "black", fill = NA) +
  #geom_point(data = study_sites, aes(x = lon, y = lat), color = "red", nudge_x = 0, nudge_y = 0.1) +
  #geom_label(data = study_sites_edit, aes(x = lon, y = lat, label = site), nudge_x = 0, nudge_y = 0) +
  geom_rect(data = south_africa_coast_hi_res,aes(xmin=18.10, xmax=18.50, ymin=-33.70, ymax=-34.50), inherit.aes = FALSE, fill = "blue", alpha = 0.01) +
  geom_rect(data = south_africa_coast_hi_res,aes(xmin=18.40, xmax=18.90, ymin=-34.00, ymax=-34.50), inherit.aes = FALSE, fill = "red", alpha = 0.01) +
  #annotate("text", label = "Warm\nTemperate", x = 18.7, y = -34.5, size = 4.0, angle = 0, colour = "black") +
  #annotate("text", label = "Cool\nTemperate", x = 18.0, y = -34.0, size = 4.0, angle = 0, colour = "black") +
  annotate("text", label = "FALSE\nBAY", x =18.65, y = -34.25, size = 4.0, angle = 0, colour = "black") +
  scaleBar(lon = 17.8, lat = -34.45, distanceLon = 10, distanceLat = 10, distanceLegend = -10, dist.unit = "km",
  arrow.length = 10, arrow.distance = 15, arrow.North.size = 3) +
  coord_cartesian(xlim = c(17.75, 19.15), ylim = c(-32.50, -34.55)) +
  #theme(axis.ticks = element_blank()) + # Remove tick marks
  xlab("Latitude") +
  ylab("Longitude")

## Coastline of Southern Africa
load("map/south_africa_coast_hi_res.Rdata")

release_sites <- read.csv("metadata/release_sites.csv", sep = ";")

## Make 2nd map of just the peninsula
release_map <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  geom_point(data = release_sites, aes(x = lon, y = lat, colour = "red"), show.legend = FALSE) +
  geom_label(data = release_sites, aes(x = lon, y = lat, label = site), nudge_x = 0, nudge_y = 0) +
  coord_cartesian(xlim = c(18.275, 18.525), ylim = c(-34.375, -33.600)) +
  theme(axis.ticks = element_blank(), # Remove tick marks
        #axis.text = element_blank(), # Remove lat/ lon numbers
        axis.title = element_blank()) # Remove lat/ lon labels
#ggsave(filename = "map_B.jpg", plot = last_plot(), device = "jpeg", path = "map/")

```

```{r map,echo=FALSE, message=FALSE, warning=FALSE, fig.cap='\\label{fig:map}Map of the study area and sampling sites. The blue shaded area is the Atlantic region and the red shaded region is the False Bay region.'}

ggarrange(map_pen, release_map, labels = c("AUTO"), align = c("hv"), ncol = 2, nrow = 1)

```

## Hydrodynamic and wind model

Both passive and kelp particles were simulated around the South African coastline within hind-cast outputs from the Copernicus Marine Environment Monitoring Service. The Copernicus outputs used in this study contains 3D daily current information from the top layer to the bottom (Global Analysis Forecast PHY_001_024). The model has a spatial resolution of 0.08$^\circ$ and is interpolated on a Arakawa C native grid. 

In order to incorporate the effects of direct wind drag within the simulations, the Copernicus Marine Environment Monitoring Service global wind product was used (WIND_L4_NRT_OBSERVATIONS_012_004). The outputs from the model is composed of 6-hourly averaged fields of surface 10m wind velocity vectors with a spatial resolution of 0.25$^\circ$. Both averaged ocean current and wind data are stored as meridonal and zonal velocity vectors. 

## Particle tracking model

The model is based on parameterisations that have been used for previous studies investigating iceberg, capsized marine vessels and microplastics. It should be noted that most of the previous studies regarding macroalgae trajectory have investigated rafts and not solitary floating individuals. A kelp raft will vary in size and can range from a few meters across to large dense mats the size of a sports field. Furthermore, some authors suggest that most macroalgae become entangled through ocean currents and not through the hydrodynamic forces that dislodge them. In addition, large kelp rafts are not a characteristics around the coast of the Cape Peninsula but rather solitary kelp are (Pers. Obs). Therefore, the trajectory of solitary *E. maxima* individuals will be considered. Previous studies have made the assumption that floating macroalage move with the same velocity as the ocean current, and instead model a ensemble of particles which trajectories are determined by a combination of ocean currents and/or the effects of winds on currents. 

Numerical calculations of particle trajectory with a Lagrangian method [@delandmeter2019], and be described by the equation

$$X(t+\Delta t) = X(t) + \int_{t}^{t+\Delta t} v(x, \tau)d \tau + \Delta X_b(t)$$
where $X$ is the three-dimensional position of a particle, $v(x,t)$ is the three-dimensional velocity field at the location in the ocean model, $X_b(t)$ is a change in position due to 'behavior' of the particle. This can range from swimming in fish to sinking or beaching. IN order to investigate the effects of drag components of trajectory of floating macroalgae, this study incorporated drag as the custom behavior. 

This study simulated two scenarios; one where the plant is fully submerged and only exposed to seawater drag; and the other where parts of the plants are partially exposed resulting in a combination of seawater and air form drag. Drag based on shape based coefficients were used in the calculations for determining the overall kelp velocity vectors. A momentum energy equation was used to calculate the drag forces for the relevant simulation. This approach has been employed in modeling iceberg drift trajectory [@andersson2017; @lichey2001; @eik2009] and was adapted to suit this particular study. The energy momentum equation used to calculate the drag force exerted on the virtual kelp particle was, $$m({d_u/d_t})=F_d + F_a + F_f$$
where $m$ is kelp mass, $d_u$ the virtual kelp particle velocity, $F_d$ the hydrodynamic drag, $F_a$ is the wind drag, and $F_f$ the surface-current flow. The assumption made was that the mass of the kelp did not change for each virtual kelp particle over the course of the simulations. Hydrodynamic drag, wind drag and surface current-flow are two-dimensional vector quantities and were calculated for each time step of each simulation. 

## Model inputs
### Cross-sectional area

In order to incorporate hydrodynamic and wind drag, the cross-sectional area of the kelp was calculated first. Known geometric shapes reflecting the relevant plant sections were used to estimate the surface area for various parts of the plant, for details please see image/table ???. The dimensional data needed was estimated in cases were data was not available for that particular morphological characteristic. The bulb/pneumatocyst is a highly variable morphological characteristic and in some cases can appear absent, the same is true for the holdfast. Therefore, the cross-sectional area of the bulb/pneumatocyst was not considered in the calculation of overall cross-sectional area. In terms of the holdfast, a standard cross-sectional area was used for simulations where the inclusion of the holdfast was considered. The cross-sectional area calculated was site specific and the dimensions needed were garnered from morphology data from a previous study [@coppin2020]. The minimum, maximum and mean were calculated for each morphological characteristic (see appendix), which were used for calculating the overall minimum, maximum and mean cross-sectional areas needed to run the various simulations. The trajectory of these "types" of cross-sectional areas (minimum, maximum and mean overall cross-sectional area) were used to determine the influence of drag, both hydrodynamic and wind, on overall trajectory. 

```{r morphology wrangling, message=FALSE, warning=FALSE, include=FALSE}
# Investigate morphology data to assist in estimating surface area

# Read in morphology data
eck_df <- read.csv("data/morph_data/eck_morph_data.csv", sep = ";") %>%
  filter(site!= "Rocky Bank") %>%   # Not using Rocky Bank in this study
  filter(site!= "De Hoop") 
eck_df$site <- as.character(eck_df$site)
eck_df <- eck_df %>% 
  filter(population == "Deep") 
eck_long_df <- gather(eck_df, Morphology, measurement, frond_mass:total_length, factor_key=TRUE)
# Summary stats to make it easier to refer to later, these will not be used any analysis.
site_list <- c("Kommetjie")
eck_stats <- eck_long_df %>% 
  group_by(site, Morphology) %>% 
  summarise(mean = mean(measurement, na.rm = T),
            minimum = min(measurement, na.rm = T),
            maximum = max(measurement, na.rm = T)) %>% 
  ungroup() %>% 
  filter(site %in% site_list) %>% 
  rename(Site = site) %>% 
  rename(Mean = mean) %>% 
  rename(Minimum = minimum) %>% 
  rename(Maximum = maximum)

eck_stats <- flextable(data = eck_stats)
eck_stats <- theme_zebra(eck_stats, odd_header = "transparent", even_header = "transparent")
eck_stats <- align(x= eck_stats, align = "center", part = "all")
eck_stats

area_table <- read.csv("tables/chapter_3/area_table.csv", sep = ";")
area_table <- flextable(data = area_table)
area_table <- theme_zebra(area_table, odd_header = "transparent", even_header = "transparent")
area_table <- align(x= area_table, align = "center", part = "all")

```

```{r area table, echo=FALSE, message=FALSE, warning=FALSE}
area_table
```

### Hydrodynamic and wind drag

The use of a spherical shape coefficient was used in the approach to simulate the trajectory of solitary floating *E. maxima*. The drag coefficient for a spherical particle was used in the calculation of hydrodynamic drag as the trajectory model assumes the particles are spherical. The cross-sectional area for each of each virtual plant was converted to the equivalent cross-sectional area for that of a sphere in the equation for calculating hydrodynamic drag: $ F_d = 0.5 \rho A_c C_d U^2$. Since drag force is dependent on the velocity vectors which vary with time, the meridonal and zonal velocities were interpolated and used in the drag force calculation for each time-step. A similar approach was used for the wind drag force. The same equation that was used to calculate hydrodynamic drag, was used to calculate the wind drag the virtual particle. Instead of estimating an ad hoc percentage of wind drag, the wind velocity vectors were interpolated for each time-step and were used in the overall calculation for wind drag force.

To test the different magnitudes that hydrodynamic and wind drag might play in the overall trajectory, simulations were run with varying degrees of drag exposure scenarios. These scenarios were meant to act as proxy for bouyancy, which determines the surface area exposed to hydrodynamic and wind drag. These estimates were expressed as percentages which were used to calculate hydrodynamic and wind drag for applicable simulation. For example, if 80% of the plant is submerged and 20% of above water, then the overall hydrodynamic and wind drag forces would be 80% and 20% of the total drag forces respectively. The exposure scenarios used in this study were 100%, 95%, 90%, and 85% for water drag; 0 %, 5%, 10%, and 15% for wind.

## Simulations

In order to determine the influence of morphology on drag components, simulations were performed for the minimum, mean and maximum cross-sectional areas for one site on the Atlantic side and one site within False Bay (see figure \ref{fig:map})

```{r sim table, echo=FALSE, message=FALSE, warning=FALSE}

sim_table <- read.csv("tables/chapter_3/simulation_table.csv", sep = ";")

sim_table <- flextable(data = sim_table)
sim_table <- theme_zebra(sim_table, odd_header = "transparent", even_header = "transparent")
sim_table <- set_header_labels(sim_table, Cross.sectional.area = "Cross-sectional area", Time.Range = "Time Range", Drag.Exposure = "Drag Exposure level")
sim_table <- align(x= sim_table, align = "center", part = "all")
sim_table

```

## Statistical analysis

# Results

```{r data wrangling, message=FALSE, warning=FALSE, include=FALSE}

# Read in simulation data and data wrangling

p_RK4 <- tidync("OceanParcels/trajectory_data/RK4_PFloat.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00")) 
p_RK4_mean <- p_RK4 %>% # calculate mean trajectory
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

p_RK4$type <- "RK4" # add extra column 'type' to dataframe and assigned 'RK4' label

Min_Kfloat_H100_W00 <- tidync("OceanParcels/trajectory_data/Min_KFloat_H100_W00.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Min_Kfloat_H100_W00_mean <- Min_Kfloat_H100_W00 %>% # calculate mean trajectory
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Min_Kfloat_H100_W00$type <- "Min_Kfloat_H100_W00" # add extra column 'type' to dataframe and assigned 'kelp' label

Min_Kfloat_H095_W05 <- tidync("OceanParcels/trajectory_data/Min_KFloat_H095_W05.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Min_Kfloat_H095_W05_mean <- Min_Kfloat_H095_W05 %>% # calculate mean trajectory
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Min_Kfloat_H095_W05$type <- "Min_Kfloat_H095_W05" # add extra column 'type' to dataframe and assigned 'kelp' label

Min_Kfloat_H090_W10 <- tidync("OceanParcels/trajectory_data/Min_KFloat_H090_W10.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Min_Kfloat_H090_W10_mean <- Min_Kfloat_H090_W10 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Min_Kfloat_H090_W10$type <- "Min_Kfloat_H090_W10" # add extra column 'type' to dataframe and assigned 'kelp' label

Min_Kfloat_H085_W15 <- tidync("OceanParcels/trajectory_data/Min_KFloat_H085_W15.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Min_Kfloat_H085_W15_mean <- Min_Kfloat_H085_W15 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Min_Kfloat_H085_W15$type <- "Min_Kfloat_H085_W15" # add extra column 'type' to dataframe and assigned 'kelp' label

Mean_Kfloat_H100_W00 <- tidync("OceanParcels/trajectory_data/Mean_KFloat_H100_W00.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Mean_Kfloat_H100_W00_mean <- Mean_Kfloat_H100_W00 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Mean_Kfloat_H100_W00$type <- "Mean_Kfloat_H100_W00" # add extra column 'type' to dataframe and assigned 'kelp' label

Mean_KFloat_H095_W05 <- tidync("OceanParcels/trajectory_data/Mean_KFloat_H095_W05.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Mean_KFloat_H095_W05_mean <- Mean_KFloat_H095_W05 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Mean_KFloat_H095_W05$type <- "Mean_KFloat_H095_W05" # add extra column 'type' to dataframe and assigned 'kelp' label

Mean_KFloat_H090_W10 <- tidync("OceanParcels/trajectory_data/Mean_KFloat_H090_W10.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Mean_KFloat_H090_W10_mean <- Mean_KFloat_H090_W10 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Mean_KFloat_H090_W10$type <- "Mean_KFloat_H090_W10" # add extra column 'type' to dataframe and assigned 'kelp' label

Mean_KFloat_H085_W15 <- tidync("OceanParcels/trajectory_data/Mean_KFloat_H085_W15.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Mean_KFloat_H085_W15_mean <- Mean_KFloat_H085_W15 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE)) 

Mean_KFloat_H085_W15$type <- "Mean_KFloat_H085_W15" # add extra column 'type' to dataframe and assigned 'kelp' label

Max_Kfloat_H100_W00 <- tidync("OceanParcels/trajectory_data/Max_KFloat_H100_W00.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Max_Kfloat_H100_W00_mean <- Max_Kfloat_H100_W00 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Max_Kfloat_H100_W00$type <- "Max_KFloat_H100_W00" # add extra column 'type' to dataframe and assigned 'kelp' label

Max_Kfloat_H095_W05 <- tidync("OceanParcels/trajectory_data/Max_KFloat_H095_W05.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Max_Kfloat_H095_W05_mean <- Max_Kfloat_H095_W05 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Max_Kfloat_H095_W05$type <- "Max_KFloat_H095_W05" # add extra column 'type' to dataframe and assigned 'kelp' label

Max_Kfloat_H090_W10 <- tidync("OceanParcels/trajectory_data/Max_KFloat_H090_W10.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Max_Kfloat_H090_W10_mean <- Max_Kfloat_H090_W10 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Max_Kfloat_H090_W10$type <- "Max_KFloat_H090_W10" # add extra column 'type' to dataframe and assigned 'kelp' label

Max_Kfloat_H085_W15 <- tidync("OceanParcels/trajectory_data/Max_KFloat_H085_W15.nc") %>%
  hyper_tibble() %>%
  dplyr::select(trajectory, lon, lat, time, distance, uwind, vwind) %>%
  dplyr::rename(t = time) %>%
  mutate(t = as.POSIXct(t, origin = "2018-01-01 00:00:00"))
Max_Kfloat_H085_W15_mean <- Max_Kfloat_H085_W15 %>% #calculate mean trajectory 
  group_by(t) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

Max_Kfloat_H085_W15$type <- "Max_KFloat_H085_W15" # add extra column 'type' to dataframe and assigned 'kelp' label

total_data <- rbind(p_RK4, Min_Kfloat_H100_W00 , Min_Kfloat_H095_W05, Min_Kfloat_H090_W10, Min_Kfloat_H085_W15, Mean_Kfloat_H100_W00, Mean_KFloat_H095_W05, Mean_KFloat_H090_W10, Mean_KFloat_H085_W15, Max_Kfloat_H100_W00, Max_Kfloat_H095_W05, Max_Kfloat_H090_W10, Max_Kfloat_H085_W15)

```

```{r density plots, message=FALSE, warning=FALSE, echo=FALSE}

## Heatmaps of study domain, use previous data for study site map and histograms

## Coastline of Southern Africa
load("map/south_africa_coast_hi_res.Rdata")

heatmap_RK4 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_RK4, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = p_RK4, bins = 80, aes(x = lon, y = lat), legend = FALSE) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  #guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Min_Kfloat_H100_W00 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_EE, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Min_Kfloat_H100_W00, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Min_Kfloat_H095_W05 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_EE, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Min_Kfloat_H095_W05, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Min_Kfloat_H090_W10 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_EE, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Min_Kfloat_H090_W10, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Min_Kfloat_H085_W15 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_EE, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Min_Kfloat_H085_W15, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Mean_Kfloat_H100_W00 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = p_EE, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Mean_Kfloat_H100_W00, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Mean_KFloat_H095_W05 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app1, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Mean_KFloat_H095_W05, bins = 80, aes(x = lon, y = lat)) +  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Mean_KFloat_H090_W10 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Mean_KFloat_H090_W10, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Mean_KFloat_H085_W15 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Mean_KFloat_H085_W15, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Max_KFloat_H100_W00 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Max_Kfloat_H100_W00, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Max_KFloat_H095_W05 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Max_Kfloat_H095_W05, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Max_KFloat_H090_W10 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Max_Kfloat_H090_W10, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

heatmap_Max_KFloat_H085_W15 <- ggplot() +
  geom_polygon(data = south_africa_coast_hi_res, aes(x = lon, y = lat, group = PID),
               size = 1.0, colour = "black", fill = NA) +
  #geom_bin2d(data = k_app2, bins = 80, aes(x = lon, y = lat)) +
  geom_hex(data = Max_Kfloat_H085_W15, bins = 80, aes(x = lon, y = lat)) +
  scale_fill_continuous(type = "viridis", limits = c(1, 13000)) +
  coord_cartesian(xlim = c(14, 20), ylim = c(-35, -30)) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  theme_bw() 

```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Comparison of density of particles within each grid cell for the end run time of each scenario.'}


a <- ggarrange(heatmap_Min_Kfloat_H100_W00, heatmap_Min_Kfloat_H095_W05,heatmap_Min_Kfloat_H090_W10,heatmap_Min_Kfloat_H085_W15, heatmap_Mean_Kfloat_H100_W00, heatmap_Mean_KFloat_H095_W05, heatmap_Mean_KFloat_H090_W10, heatmap_Mean_KFloat_H085_W15, heatmap_Max_KFloat_H100_W00,heatmap_Max_KFloat_H095_W05, heatmap_Max_KFloat_H090_W10, heatmap_Max_KFloat_H085_W15 , labels = c("AUTO"), common.legend = TRUE, legend = c("none"))

ggarrange(heatmap_RK4, a, common.legend = TRUE, legend = c("right"), ncol = 1, nrow = 2)

```

```{r path plots, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE}

min_area_path <- ggplot() + 
  geom_path(data = Min_Kfloat_H100_W00_mean,aes(x = lon, y = lat, color = 'red'), show.legend = FALSE) +
  geom_path(data = Min_Kfloat_H095_W05_mean,aes(x = lon, y = lat, color = 'blue'), show.legend = FALSE) +
  geom_path(data = Min_Kfloat_H090_W10_mean,aes(x = lon, y = lat, color = 'yellow'), show.legend = FALSE) +
  geom_path(data = Min_Kfloat_H085_W15_mean,aes(x = lon, y = lat, color = 'pink'), show.legend = FALSE) + 
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  ggtitle("Minimum cross-sectional area") + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

mean_area_path <- ggplot() + 
  geom_path(data = Mean_Kfloat_H100_W00_mean,aes(x = lon, y = lat, color = 'red'), show.legend = FALSE) +
  geom_path(data = Mean_KFloat_H095_W05_mean,aes(x = lon, y = lat, color = 'blue'), show.legend = FALSE) +
  geom_path(data = Mean_KFloat_H090_W10_mean,aes(x = lon, y = lat, color = 'yellow'), show.legend = FALSE) +
  geom_path(data = Mean_KFloat_H085_W15_mean,aes(x = lon, y = lat, color = 'pink'), show.legend = FALSE) +
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  ggtitle("Mean cross-sectional area") + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

max_area_path <- ggplot() + 
  geom_path(data = Max_Kfloat_H100_W00_mean,aes(x = lon, y = lat, color = 'red'), show.legend = FALSE) +
  geom_path(data = Max_Kfloat_H095_W05_mean,aes(x = lon, y = lat, color = 'blue'), show.legend = FALSE) +
  geom_path(data = Max_Kfloat_H090_W10_mean,aes(x = lon, y = lat, color = 'yellow'), show.legend = FALSE) +
  geom_path(data = Max_Kfloat_H085_W15_mean,aes(x = lon, y = lat, color = 'pink'), show.legend = FALSE) +
  xlab("Longtitude") + 
  ylab("Latitude") + 
  guides(fill=guide_legend(title="Number of particles")) +
  ggtitle("Maximum cross-sectional area") + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggarrange(min_area_path, mean_area_path, max_area_path, labels = "AUTO")

```

```{r trajectory plots, echo=FALSE, message=FALSE, warning=FALSE}

total_mean_traj <- total_data %>% #calculate mean trajectory 
  group_by(t, type) %>% 
  summarise(across(lon:lat, mean, na.rm= TRUE))

lon_plot <- ggplot() +
  geom_point(data = total_mean_traj, aes(x = t, y = lon, color = type)) +
  xlab("Time") +
  ylab("Longitude") +
  theme_bw() +
  guides(fill=guide_legend(title="Type")) 


lat_plot <- ggplot() +
  geom_point(data = total_mean_traj, aes(x = t, y = lat, color = type)) +
  xlab("Time") +
  ylab("Latitude") +
  theme_bw() +
  guides(fill=guide_legend(title="Type"))

ggarrange(lon_plot, lat_plot, labels = "AUTO", common.legend = TRUE, ncol = 1, nrow = 2, legend = "right")

```

```{r distance plot processing, message=FALSE, warning=FALSE, include=FALSE}
pos <- c("RK4",
         "Min_Kfloat_H100_W00",
         "Min_Kfloat_H095_W05",
         "Min_Kfloat_H090_W10",
         "Min_Kfloat_H085_W15",
         "Mean_Kfloat_H100_W00",
         "Mean_Kfloat_H095_W05",
         "Mean_Kfloat_H090_W10",
         "Mean_Kfloat_H085_W15",
         "Max_Kfloat_H100_W00",
         "Max_Kfloat_H095_W05",
         "Max_Kfloat_H090_W10",
         "Max_Kfloat_H085_W15")

dis_plot <- ggplot(data = total_data, aes(x = type, y = distance, fill = type, show.legend = FALSE))+
  geom_boxplot(notch = TRUE, notchwidth = 1, show.legend = FALSE, stat = "boxplot") +
  #scale_x_discrete(limits = pos)+
  stat_compare_means(method = "kruskal.test", label = "p.signif")+
  theme_bw()+
  ylab("Distance (km)")+
  xlab("Type")+
  coord_flip()

```

```{r distance plot, message=FALSE, warning=FALSE}
dis_plot
```

# Discussion

# Appendix

# References

